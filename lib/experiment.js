// Generated by CoffeeScript 1.7.1
(function() {
  var Experiment;

  Experiment = (function() {
    Experiment.store = null;

    function Experiment(name, store) {
      this.name = name;
      this.store = store;
      this._variants = [];
    }

    Experiment.prototype.variant = function(name, pct, value) {
      var _ref;
      if (value == null) {
        _ref = [pct, 100], value = _ref[0], pct = _ref[1];
      }
      this._variants.push({
        name: name,
        pct: pct,
        value: value
      });
      return this;
    };

    Experiment.prototype.run = function() {
      var i, rand, variant, variantName, variantsSum, _base, _base1, _i, _j, _len, _len1, _ref, _ref1, _ref2, _ref3;
      if ((variantName = (_ref = this.store) != null ? _ref.get(this.name) : void 0) != null) {
        this.chosen = this._variants.filter(function(v) {
          return v.name === variantName;
        })[0];
        if (this.chosen != null) {
          if (typeof (_base = this.chosen).value === "function") {
            _base.value();
          }
        }
      } else {
        variantsSum = 0;
        _ref1 = this._variants;
        for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
          variant = _ref1[_i];
          variantsSum += variant.pct;
        }
        if (variantsSum !== 100) {
          throw new Error("experiment " + this.name + " has invalid percentages");
        }
        i = 0;
        rand = Math.random() * 100;
        _ref2 = this._variants;
        for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {
          variant = _ref2[_j];
          i += variant.pct;
          if (i >= rand) {
            this.chosen = variant;
            if (typeof (_base1 = this.chosen).value === "function") {
              _base1.value();
            }
            break;
          }
        }
      }
      if ((_ref3 = this.store) != null) {
        _ref3.addResult(this.name, this.chosen.name);
      }
      return this.chosen;
    };

    return Experiment;

  })();

  module.exports = Experiment;

}).call(this);
